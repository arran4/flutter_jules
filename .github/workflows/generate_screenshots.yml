name: Generate Screenshots

on:
  workflow_dispatch:
  push:
    paths:
      - 'lib/**'
      - 'test/**'
      - 'integration_test/**'
      - '.github/workflows/generate_screenshots.yml'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-screenshots:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev xvfb
          flutter pub get

      - name: Run Integration Tests
        run: |
          xvfb-run -a flutter test integration_test/screenshot_test.dart -d linux

      - name: Check for changes
        id: check_changes
        run: |
          git status
          if [[ -n $(git status -s screenshots/) ]]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Create Pull Request
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update screenshots"
          title: "chore: update screenshots"
          body: "This PR updates the screenshots generated by the integration test."
          branch: "chore/update-screenshots"
          base: "main"
          add-paths: |
            screenshots/*.png
